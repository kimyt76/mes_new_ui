import{r as g,u as ne,a as oe,y as le,p as re,k as se,B as L,m as ie,A as ce,c as de,f as I,g as a,d as p,w as l,F as ue,e as me,o as O,j as pe,i as fe,t as S,b as ve,z as we}from"./index-WOYElqRf.js";import{i as N,d as _e,e as j}from"./common-DT3ZdnD0.js";import{A as h}from"./apiLab-BqEJ0S91.js";import{A as ge}from"./apiItem-CodyMnFg.js";import{H as y,_ as Ne}from"./index-CxEtZ2a1.js";import{_ as he}from"./UserListPop-DFPdUKXl.js";import{_ as ye}from"./ClientListPop-CdAeQKJQ.js";import"./format-DWu4U6B8.js";import"./_commonjsHelpers-CZnAS8i4.js";import"./apiBase-BxtsCvh9.js";const be=["id"],Se={__name:"RecipeDetail",setup(Ie){const R=g(!1),b=g(null),{vError:P,vSuccess:B,vInfo:D,vWarning:C}=ne(),E=me(),M=re(),{userId:H}=oe(),A=g(null),V=le(null),T=M.params.id,U=g(""),f=g([{phase:"",itemCd:"",itemName:"",content:0,inPrice:0,unitPrice:0}]),F=g([]),o=se({clientName:"",clientId:"",prodName:"",managerName:"",managerId:"",regDate:"",labNo:"",prodType:"",recipeId:T,userId:H}),z=[{data:"sortDist",readOnly:!0,className:"htCenter",width:60},{data:"phase",type:y.cellTypes.text,width:60,className:"htCenter"},{data:"itemCd",type:y.cellTypes.text,width:180,className:"htCenter"},{data:"itemName",type:y.cellTypes.text,width:720},{data:"content",type:y.cellTypes.numeric,width:200,className:"htRight"},{data:"inPrice",type:y.cellTypes.numeric,width:200,className:"htRight"},{data:"unitPrice",type:y.cellTypes.numeric,width:200,className:"htRight"}],J=async()=>{if(N(o.clientName)){C("고객사 정보를 입력해주세요.");return}if(N(o.prodName)){C("제품명을 입력해주세요.");return}if($.value!==100){C("함량의 합이 100이 아닙니다. 확인해주세요.");return}try{const t={recipeInfo:{...o},recipeList:f.value};t.recipeInfo.regDate=j(t.recipeInfo.regDate);const e=await h.saveRecipeInfo(t);o.recipeId=e.data.recipeId,B("저장되었습니다.")}catch(t){P(t.message||"저장 중 오류가 발생했습니다.")}},k=t=>{U.value=t,t==="C"?V.value=ye:t==="U"&&(V.value=he),R.value=!0},K=t=>{U.value==="C"?(o.clientName=t.clientName,o.clientId=t.clientId):U.value==="U"&&(o.managerId=t.userId,o.managerName=t.memberNm)},W=async(t,e)=>{var r,d;if(!t)return;const n=(d=(r=b.value)==null?void 0:r.hotInstance)==null?void 0:d.hotInstance;if(!n)return;let s=0;for(const[u,x,m,v]of t){if(x==="itemCd"&&v&&v!==m)try{s=s+1,n.setDataAtRowProp(u,"sortDist",s);let c=null;if(v.charAt(0).toUpperCase()==="J"?c=await ge.getItemInfo(v):(c=await h.getNewMaterialInfo(v),c=c.getNewMaterialInfo),c){n.setDataAtRowProp(u,"inPrice",c.inPrice||0);const w=Number(n.getDataAtRowProp(u,"content"));if(!isNaN(w)&&c.inPrice!=null){let _=w*c.inPrice*.001*.01;_=parseFloat(_.toFixed(7)),n.setDataAtRowProp(u,"unitPrice",_)}}else n.setDataAtRowProp(u,"inPrice",0)}catch(c){console.error("품목 조회 오류:",c)}if(x==="content"&&v!==m){const c=Number(v),w=Number(n.getDataAtRowProp(u,"inPrice"));if(!isNaN(c)&&!isNaN(w)&&w>0){const _=parseFloat((c*w*.001*.01).toFixed(7));n.setDataAtRowProp(u,"unitPrice",_)}}}},$=L(()=>{const t=f.value.reduce((e,n)=>e+(Number(n.content)||0),0);return parseFloat(t.toFixed(7))}),q=L(()=>f.value.reduce((t,e)=>t+(Number(e.inPrice)||0),0)),G=L(()=>f.value.reduce((t,e)=>t+(Number(e.unitPrice)||0),0).toFixed(7)),Q=()=>{var r,d;const t=(d=(r=b.value)==null?void 0:r.hotInstance)==null?void 0:d.hotInstance,e=(t==null?void 0:t.getSourceData())||[],n=e.length>0?Math.max(...e.map(u=>u.sortDist||0))+1:1,s={sort_dist:n,phase:"",itemCd:"",itemName:"",content:0,inPrice:0,unitPrice:0};console.log("hotInstance",t),t?(t.alter("insert_row_above",e.length),t.setDataAtRowProp(e.length,"sortDist",n),t.setDataAtRowProp(e.length,"phase",""),t.setDataAtRowProp(e.length,"itemCd",""),t.setDataAtRowProp(e.length,"itemName",""),t.setDataAtRowProp(e.length,"content",0),t.setDataAtRowProp(e.length,"inPrice",0),t.setDataAtRowProp(e.length,"unitPrice",0)):f.value.push(s)},X=(t,e,n,s)=>{A.value=[t,e,n,s]},Y=()=>{var s,r;if(!A.value){C("삭제할 행을 선택하세요.");return}const[t,,e]=A.value,n=(r=(s=b.value)==null?void 0:s.hotInstance)==null?void 0:r.hotInstance;n&&n.alter("remove_row",t,e-t+1)};ie(async()=>{var e;if(F.value=await ce.getCodeList("prod_type"),!!((e=b.value)==null?void 0:e.hotInstance))if(N(o.recipeId))o.regDate=_e();else{const n=await h.getRecipeInfo(o.recipeId);Object.assign(o,n.recipeInfo),f.value.splice(0,f.value.length,...n.recipeList)}});const Z=async()=>{if(N(o.recipeId)){D("처방정보가 없습니다. 저장 후 시도해주세요.");return}try{const t={recipeInfo:{...o},recipeList:f.value},e=await h.downloadRecipe(t),n=window.URL.createObjectURL(e),s=document.createElement("a");s.href=n,s.download=`recipe_${o.prodName}.xlsx`,s.click(),window.URL.revokeObjectURL(n)}catch(t){P("엑셀 다운로드 실패",t)}},ee=async()=>{if(N(o.recipeId)){D("처방정보가 없습니다. 저장 후 시도해주세요.");return}try{const t=await h.downloadIngredient(o.recipeId),e=window.URL.createObjectURL(t),n=document.createElement("a");n.href=e,n.download=`전성분_${o.prodName}.xlsx`,n.click(),window.URL.revokeObjectURL(e)}catch(t){P("엑셀 다운로드 실패",t)}},te=async()=>{if(N(o.recipeId)){D("처방정보가 없습니다. 저장 후 시도해주세요.");return}try{const t=await h.downloadIngredientCn(T),e=window.URL.createObjectURL(t),n=document.createElement("a");n.href=e,n.download=`중국위행허가_${o.prodName}.xlsx`,n.click(),window.URL.revokeObjectURL(e)}catch(t){P("엑셀 다운로드 실패",t)}},ae=()=>{E.push({name:"RecipeList"})};return(t,e)=>{const n=p("v-breadcrumbs"),s=p("v-text-field"),r=p("v-col"),d=p("v-row"),u=p("v-date-input"),x=p("v-select"),m=p("v-btn"),v=p("v-form"),c=p("v-card-text"),w=p("v-card"),_=p("v-dialog");return O(),de(ue,null,[I("div",{id:t.$attrs.id},null,8,be),a(n,{items:["MES","연구관리","처방상세"]}),a(w,null,{default:l(()=>[a(c,null,{default:l(()=>[a(v,{onSubmit:pe(J,["prevent"])},{default:l(()=>[a(d,null,{default:l(()=>[a(r,null,{default:l(()=>[a(s,{modelValue:o.clientName,"onUpdate:modelValue":e[0]||(e[0]=i=>o.clientName=i),label:"고객사",variant:"underlined",density:"compact","append-inner-icon":"mdi-magnify","onClick:appendInner":e[1]||(e[1]=i=>k("C"))},null,8,["modelValue"])]),_:1}),a(r,null,{default:l(()=>[a(s,{modelValue:o.prodName,"onUpdate:modelValue":e[2]||(e[2]=i=>o.prodName=i),label:"제품명",variant:"underlined",density:"compact"},null,8,["modelValue"])]),_:1})]),_:1}),a(d,null,{default:l(()=>[a(r,null,{default:l(()=>[a(s,{modelValue:o.managerName,"onUpdate:modelValue":e[3]||(e[3]=i=>o.managerName=i),label:"담당자명",variant:"underlined",density:"compact","append-inner-icon":"mdi-magnify","onClick:appendInner":e[4]||(e[4]=i=>k("U"))},null,8,["modelValue"])]),_:1}),a(r,null,{default:l(()=>[a(u,{modelValue:o.regDate,"onUpdate:modelValue":e[5]||(e[5]=i=>o.regDate=i),label:"등록일","display-format":fe(j),variant:"underlined",density:"compact"},null,8,["modelValue","display-format"])]),_:1}),a(r,null,{default:l(()=>[a(s,{modelValue:o.labNo,"onUpdate:modelValue":e[6]||(e[6]=i=>o.labNo=i),label:"Lab No",variant:"underlined",density:"compact"},null,8,["modelValue"])]),_:1}),a(r,null,{default:l(()=>[a(x,{modelValue:o.prodType,"onUpdate:modelValue":e[7]||(e[7]=i=>o.prodType=i),label:"제품코드",items:F.value,"item-title":"codeNm","item-value":"code",variant:"underlined",density:"compact"},null,8,["modelValue","items"])]),_:1})]),_:1}),a(d,{class:"justify-end mb-3 mr-2",dense:""},{default:l(()=>[a(r,{cols:"auto"},{default:l(()=>[a(m,{color:"brown-lighten-4",class:"mt-3 mr-3",text:"추가+",density:"compact",onClick:Q})]),_:1}),a(r,{cols:"auto"},{default:l(()=>[a(m,{color:"brown-lighten-4",class:"mt-3",text:"삭제-",density:"compact",onClick:Y})]),_:1})]),_:1}),a(d,null,{default:l(()=>[a(r,null,{default:l(()=>[a(Ne,{ref_key:"hotTable",ref:b,data:f.value,colHeaders:["No.","Phase","품목코드","품목명","함량","원가(원)","단가(원/g)"],columns:z,stretchH:"none",height:430,afterChange:W,afterSelection:X},null,8,["data"])]),_:1})]),_:1}),a(d,{class:"d-flex justify-end mb-2 mr-3 dense"},{default:l(()=>[a(r,{cols:"auto"},{default:l(()=>e[11]||(e[11]=[I("strong",null,"합계",-1)])),_:1}),a(r,{cols:"auto"},{default:l(()=>[I("span",null,"함량 : "+S($.value)+"%",1)]),_:1}),a(r,{cols:"auto"},{default:l(()=>[I("span",null,"원가(원) : "+S(q.value.toLocaleString("ko-kr"))+"원",1)]),_:1}),a(r,{cols:"auto"},{default:l(()=>[I("span",null,"단가(원/g) : "+S(G.value)+"원",1)]),_:1})]),_:1}),a(d,{class:"justify-end mb-3 mr-2",dense:""},{default:l(()=>[a(r,{cols:"auto"},{default:l(()=>[a(m,{text:"BOM연결",onClick:e[8]||(e[8]=i=>k("B"))})]),_:1}),a(r,{cols:"auto"},{default:l(()=>[a(m,{text:"저장",color:"brown-lighten-4",type:"submit"})]),_:1}),a(r,{cols:"auto"},{default:l(()=>[a(m,{text:"전성분(수출)",color:"#FFE0B2",onClick:ee})]),_:1}),a(r,{cols:"auto"},{default:l(()=>[a(m,{text:"단가",onClick:Z})]),_:1}),a(r,{cols:"auto"},{default:l(()=>[a(m,{text:"중국위행허가",onClick:te})]),_:1}),a(r,{cols:"auto"},{default:l(()=>[a(m,{text:"목록",onClick:ae})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),a(_,{modelValue:R.value,"onUpdate:modelValue":e[10]||(e[10]=i=>R.value=i),width:"800px",height:"800px",persistent:"",scrim:!1},{default:l(()=>[(O(),ve(we(V.value),{id:t.id,onSelected:K,onCloseDialog:e[9]||(e[9]=i=>R.value=!1)},null,40,["id"]))]),_:1},8,["modelValue"])],64)}}};export{Se as default};

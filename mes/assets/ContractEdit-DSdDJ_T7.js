import{_ as ue,a as de,p as re,u as ce,r as v,x as me,k as pe,z as C,q as O,m as ve,A as k,c as ye,f as y,g as a,d as u,w as i,F as fe,e as _e,o as R,j as ge,i as J,h as we,B as w,C as h,b as he,y as Ve}from"./index-DbwVXjcr.js";import{e as f,l as M,i as be}from"./common-BCog4hmn.js";import{A as z}from"./apiOrders-UQLCal3q.js";import{_ as xe}from"./MultiFileUpload-KCUNNr7a.js";import{_ as Pe,a as Ne}from"./ClientListPop-DSUYNVnf.js";import{_ as Ce}from"./UserListPop-C1yrHg2z.js";import"./format-CBpsKyOP.js";import"./filedownLoad-CMEUJAlR.js";import"./apiItem-BapmxV41.js";import"./apiBase--1t-TlkM.js";const ke=["id"],Ue=["onUpdate:modelValue","onBlur"],De=["onUpdate:modelValue","onBlur"],Ie=["onUpdate:modelValue"],Te=["onUpdate:modelValue"],qe=["onUpdate:modelValue"],Se=["onUpdate:modelValue"],Fe={__name:"ContractEdit",setup($e){const{userId:G}=de(),q=re().params.id,{vError:H,vSuccess:W}=ce(),S=_e(),V=v(!1),b=me(null);let U=v(""),F=v(0);const l=v([]),$=v([]),B=v([]),A=v([]),_=v([]),x=v(""),P=v(""),o=pe({contractDate:"",seq:"",expectedDueDate:"",clientName:"",clientId:"",managerName:"",managerId:"",paymentCondition:"",vatType:"",orderType:"",userId:G}),j=[{title:"품목코드 ",key:"itemCd",align:"center",width:"120px"},{title:"품목명",key:"itemName",align:"start",width:"380px"},{title:"규격",key:"unit",align:"center",width:"80px"},{title:"제품유형",key:"itemGrp1",align:"center",width:"100px"},{title:"수량",key:"qty",align:"center",width:"80px"},{title:"단가",key:"unitPrice",align:"center",width:"80px"},{title:"공급가액",key:"supplyPrice",align:"center",width:"110px"},{title:"부가세",key:"vatPrice",align:"center",width:"100px"},{title:"합계",key:"totPrice",align:"center",width:"100px"},{title:"차수   ",key:"orderCnt",align:"center",width:"80px"},{title:"진행상태",key:"statusType",align:"center",width:"110px"},{title:"비고",key:"etc",align:"center",width:"100px"},{title:"-",key:"actions",align:"center",width:"10px"}];C(()=>l.value.reduce((t,e)=>t+Number(e.qty||0),0));const K=C(()=>l.value.reduce((t,e)=>t+Number(e.supplyPrice||0),0)),Q=C(()=>l.value.reduce((t,e)=>t+Number(e.vatPrice||0),0));C(()=>K.value+Q.value);const X=async()=>{const t=new FormData;try{const e={...o};e.contractDate=f(e.contractDate),e.expectedDueDate=f(e.expectedDueDate),t.append("contractInfo",JSON.stringify(e)),t.append("itemList",JSON.stringify(l.value));const d=[];_.value.forEach(m=>{m.flag==="N"?t.append("newFiles",m.file):m.flag==="D"&&d.push({attachFileId:m.attachFileId,seq:m.seq})}),t.append("keptFiles",JSON.stringify(_.value.filter(m=>m.flag==="S"))),d.length>0&&t.append("deleteFiles",new Blob([JSON.stringify(d)],{type:"application/json"}));const c=await z.updateContractInfo(t);W(c),S.push({name:"ContractDetail",params:{id:q}})}catch(e){H(e.message)}};O(()=>o.contractDate,async(t,e)=>{be(f(e))||e!==f(t)&&(o.seq=await k.getNextSeq("tb_contract_mst","contract_Date",f(t)))}),O(()=>o.vatType,async t=>{o.vatType==="VRN"?l.value.map(e=>{e.vatPrice=0}):l.value.map(e=>{e.vatPrice=M(e.supplyPrice)})});const L=t=>{const e=Number(l.value[t].qty),d=Number(l.value[t].unitPrice);!isNaN(e)&&!isNaN(d)?l.value[t].supplyPrice=e*d:l.value[t].supplyPrice=0,isNaN(l.value[t].supplyPrice)?l.value[t].vatPrice=0:l.value[t].vatPrice=M(l.value[t].supplyPrice),isNaN(l.value[t].supplyPrice)?l.value[t].totPrice=0:l.value[t].totPrice=l.value[t].supplyPrice+l.value[t].vatPrice},Y=t=>{switch(U.value){case"C":o.clientName=t.clientName,o.clientId=t.clientId;break;case"U":o.managerName=t.memberNm,o.managerId=t.userId;break;case"I":Z(t);break}U.value=""},Z=t=>{if(!Array.isArray(t))return;let e=F.value;const d=t.map((c,m)=>({itemCd:c.itemCd,itemName:c.itemName,unit:c.unit,prodType:c.prodType,qty:c.qty,unitPrice:c.unitPrice,supplyPrice:c.supplyPrice,vatPrice:0,totPrice:0,orderCnt:"",statusType:"",etc:c.etc,orderDist:e+m+1}));l.value.length>0?l.value.push(...d):l.value=[...d]},D=t=>{switch(U.value=t,t){case"C":b.value=Ne,x.value="800px",P.value="800px";break;case"U":b.value=Ce,x.value="800px",P.value="800px";break;case"I":b.value=Pe,x.value="800px",P.value="850px";break}V.value=!0},ee=t=>{const e=l.value.findIndex(d=>d.itemCd===t);l.value.splice(e,1)};ve(async()=>{$.value=await k.getCodeList("order_type"),A.value=await k.getCodeList("status_Type"),B.value=await k.getCodeList("vat_type");const t=await z.getContractInfo(q);Object.assign(o,t.contractInfo),t.attachFileInfo!==null?_.value=t.attachFileInfo:_.value=[],l.value=t.itemList,F.value=l.value.length});const te=()=>{S.push({name:"ContractList"})};return(t,e)=>{const d=u("v-breadcrumbs"),c=u("v-card-item"),m=u("v-date-input"),N=u("v-text-field"),p=u("v-col"),g=u("v-row"),I=u("v-select"),E=u("v-card-text"),ae=u("v-card-subtitle"),T=u("v-btn"),le=u("v-icon"),ne=u("v-data-table-virtual"),ie=u("v-form"),oe=u("v-card"),se=u("v-dialog");return R(),ye(fe,null,[y("div",{id:t.$attrs.id},null,8,ke),a(d,{items:["MES","영업관리","주문수정"],class:"custom-breadcrumbs"}),a(oe,null,{default:i(()=>[a(c,{title:"주문서입력"}),a(ie,{ref:"vform",onSubmit:ge(X,["prevent"])},{default:i(()=>[a(E,null,{default:i(()=>[a(g,null,{default:i(()=>[a(p,{class:"d-flex ga-2 pa-1"},{default:i(()=>[a(m,{modelValue:o.contractDate,"onUpdate:modelValue":e[0]||(e[0]=n=>o.contractDate=n),label:"주문일자",density:"compact","display-format":J(f),variant:"underlined",style:{width:"200px"}},null,8,["modelValue","display-format"]),a(N,{modelValue:o.seq,"onUpdate:modelValue":e[1]||(e[1]=n=>o.seq=n),density:"compact",style:{width:"40px"},readonly:""},null,8,["modelValue"])]),_:1}),a(p,null,{default:i(()=>[a(m,{modelValue:o.expectedDueDate,"onUpdate:modelValue":e[2]||(e[2]=n=>o.expectedDueDate=n),label:"납기예정일자",density:"compact","display-format":J(f),variant:"underlined",style:{width:"200px"},"hide-details":""},null,8,["modelValue","display-format"])]),_:1}),a(p,null,{default:i(()=>[a(N,{modelValue:o.paymentCondition,"onUpdate:modelValue":e[3]||(e[3]=n=>o.paymentCondition=n),label:"결제조건",variant:"underlined",density:"compact",style:{width:"200px"},"hide-details":""},null,8,["modelValue"])]),_:1}),a(p,null,{default:i(()=>[a(N,{modelValue:o.managerName,"onUpdate:modelValue":e[4]||(e[4]=n=>o.managerName=n),label:"담당자명",variant:"underlined",density:"compact","append-inner-icon":"mdi-magnify","onClick:appendInner":e[5]||(e[5]=n=>D("U")),style:{width:"200px"}},null,8,["modelValue"])]),_:1})]),_:1}),a(g,null,{default:i(()=>[a(p,{cols:"6"},{default:i(()=>[a(N,{modelValue:o.clientName,"onUpdate:modelValue":e[6]||(e[6]=n=>o.clientName=n),label:"고객사",variant:"underlined",density:"compact","append-inner-icon":"mdi-magnify","onClick:appendInner":e[7]||(e[7]=n=>D("C"))},null,8,["modelValue"])]),_:1}),a(p,null,{default:i(()=>[a(I,{modelValue:o.vatType,"onUpdate:modelValue":e[8]||(e[8]=n=>o.vatType=n),label:"거래유형",items:B.value,"item-title":"codeNm","item-value":"code",variant:"underlined",density:"compact",style:{width:"200px"}},null,8,["modelValue","items"])]),_:1}),a(p,null,{default:i(()=>[a(I,{modelValue:o.orderType,"onUpdate:modelValue":e[9]||(e[9]=n=>o.orderType=n),label:"수주유형",items:$.value,"item-title":"codeNm","item-value":"code",variant:"underlined",density:"compact",style:{width:"200px"}},null,8,["modelValue","items"])]),_:1})]),_:1}),a(g,null,{default:i(()=>[a(p,{cols:"12"},{default:i(()=>[a(xe,{modelValue:_.value,"onUpdate:modelValue":e[10]||(e[10]=n=>_.value=n)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(E,null,{default:i(()=>[a(g,null,{default:i(()=>[a(p,null,{default:i(()=>[a(ae,null,{default:i(()=>e[14]||(e[14]=[we(" - 품목 ")])),_:1})]),_:1}),a(p,{class:"d-flex ga-4 justify-end"},{default:i(()=>[a(T,{text:"추가 +",density:"compact",onClick:e[11]||(e[11]=n=>D("I"))})]),_:1})]),_:1}),a(g,null,{default:i(()=>[a(p,null,{default:i(()=>[a(ne,{headers:j,items:l.value,density:"compact","item-value":"id",class:"custom-table no-padding-table"},{"item.statusType":i(({item:n})=>[a(I,{modelValue:n.statusType,"onUpdate:modelValue":s=>n.statusType=s,items:A.value,"item-title":"codeNm","item-value":"code",density:"compact",variant:"outlined",style:{width:"120px",height:"40px"}},null,8,["modelValue","onUpdate:modelValue","items"])]),"item.qty":i(({item:n,index:s})=>[w(y("input",{"onUpdate:modelValue":r=>l.value[s].qty=r,style:{"text-align":"right",width:"90%"},class:"custom-line",onBlur:r=>L(s)},null,40,Ue),[[h,l.value[s].qty]])]),"item.unitPrice":i(({item:n,index:s})=>[w(y("input",{"onUpdate:modelValue":r=>l.value[s].unitPrice=r,style:{"text-align":"right",width:"90%","min-width":"90%","max-width":"90%"},class:"custom-line",onBlur:r=>L(s)},null,40,De),[[h,l.value[s].unitPrice]])]),"item.supplyPrice":i(({item:n,index:s})=>[w(y("input",{"onUpdate:modelValue":r=>l.value[s].supplyPrice=r,type:"number",style:{"text-align":"right",width:"90%","min-width":"90%","max-width":"90%"},class:"custom-line"},null,8,Ie),[[h,l.value[s].supplyPrice]])]),"item.vatPrice":i(({item:n,index:s})=>[w(y("input",{"onUpdate:modelValue":r=>l.value[s].vatPrice=r,type:"number",style:{"text-align":"right",width:"90%","min-width":"90%","max-width":"90%"},class:"custom-line"},null,8,Te),[[h,l.value[s].vatPrice,void 0,{number:!0}]])]),"item.totPrice":i(({item:n,index:s})=>[w(y("input",{"onUpdate:modelValue":r=>l.value[s].totPrice=r,type:"number",style:{"text-align":"right",width:"90%","min-width":"90%","max-width":"90%"},class:"custom-line"},null,8,qe),[[h,l.value[s].totPrice,void 0,{number:!0}]])]),"item.etc":i(({item:n,index:s})=>[w(y("input",{"onUpdate:modelValue":r=>l.value[s].etc=r,type:"text",style:{"text-align":"left",width:"90%","min-width":"90%","max-width":"90%"},class:"custom-line"},null,8,Se),[[h,l.value[s].etc]])]),"item.actions":i(({item:n})=>[a(le,{color:"medium-emphasis",icon:"mdi-delete",size:"small",onClick:s=>ee(n.itemCd)},null,8,["onClick"])]),_:1},8,["items"])]),_:1})]),_:1}),a(g,{class:"mt-2 mb-2"},{default:i(()=>[a(p,{class:"d-flex ga-4 justify-end"},{default:i(()=>[a(T,{text:"저장",class:"gt-2",color:"brown-lighten-4",type:"submit"}),a(T,{text:"목록",class:"mr-3",onClick:te})]),_:1})]),_:1})]),_:1})]),_:1},512)]),_:1}),a(se,{modelValue:V.value,"onUpdate:modelValue":e[13]||(e[13]=n=>V.value=n),width:x.value,height:P.value,persistent:""},{default:i(()=>[(R(),he(Ve(b.value),{id:t.id,onSelected:Y,onCloseDialog:e[12]||(e[12]=n=>V.value=!1)},null,40,["id"]))]),_:1},8,["modelValue","width","height"])],64)}}},We=ue(Fe,[["__scopeId","data-v-73bce1c4"]]);export{We as default};

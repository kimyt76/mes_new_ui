import{K as ue,M as de,a1 as re,L as me,A as v,Z as ce,W as pe,a8 as C,J as M,H as ve,e as ye,h as y,p as a,k as u,l as n,F as fe,N as _e,o as O,P as ge,a2 as R,y as we,w,ad as h,i as he,j as Ve}from"./index-BCdxernO.js";import{A as k}from"./apiCommon-DQdCmI3G.js";import{A as J}from"./apiOrders-LBbh7QBG.js";import{_ as Pe}from"./MultiFileUpload-CUf0c4Ii.js";import{g as f,j as H,i as xe}from"./common-Ctgf_4Dl.js";import{I as be}from"./ItemListMultiPop-BS5GtrW8.js";import{C as Ne}from"./ClientListPop-BQhfi3oc.js";import{U as Ce}from"./UserListPop-40qvmJxy.js";import"./filedownLoad-Cs3MYRER.js";import"./index-CEOpAmiF.js";import"./index-Z2YNGKhZ.js";import"./index-CKfU0QJd.js";import"./index-WWuz9eST.js";import"./index-BGn1OEmN.js";import"./index-DhHuXiFi.js";import"./apiItem-B0JHHkd5.js";import"./apiBase-DJzL_JWR.js";import"./apiSystem-BBpYMteA.js";const ke=["id"],Ue=["onUpdate:modelValue","onBlur"],Ie=["onUpdate:modelValue","onBlur"],De=["onUpdate:modelValue"],Te=["onUpdate:modelValue"],qe=["onUpdate:modelValue"],Se=["onUpdate:modelValue"],Fe={__name:"ContractEdit",setup(Le){const{userId:W}=de(),q=re().params.id,{vError:j,vSuccess:z}=me(),S=_e(),V=v(!1),P=ce(null);let U=v(""),F=v(0);const l=v([]),L=v([]),A=v([]),B=v([]),_=v([]),x=v(""),b=v(""),o=pe({contractDate:"",seq:"",expectedDueDate:"",clientName:"",clientId:"",managerName:"",managerId:"",paymentCondition:"",vatType:"",orderType:"",userId:W}),G=[{title:"품목코드 ",key:"itemCd",align:"center",width:"120px"},{title:"품목명",key:"itemName",align:"start",width:"380px"},{title:"규격",key:"unit",align:"center",width:"80px"},{title:"제품유형",key:"itemGrp1",align:"center",width:"100px"},{title:"수량",key:"qty",align:"center",width:"80px"},{title:"단가",key:"unitPrice",align:"center",width:"80px"},{title:"공급가액",key:"supplyPrice",align:"center",width:"110px"},{title:"부가세",key:"vatPrice",align:"center",width:"100px"},{title:"합계",key:"totPrice",align:"center",width:"100px"},{title:"차수   ",key:"orderCnt",align:"center",width:"80px"},{title:"진행상태",key:"statusType",align:"center",width:"110px"},{title:"비고",key:"etc",align:"center",width:"100px"},{title:"-",key:"actions",align:"center",width:"10px"}];C(()=>l.value.reduce((t,e)=>t+Number(e.qty||0),0));const K=C(()=>l.value.reduce((t,e)=>t+Number(e.supplyPrice||0),0)),Z=C(()=>l.value.reduce((t,e)=>t+Number(e.vatPrice||0),0));C(()=>K.value+Z.value);const Q=async()=>{const t=new FormData;try{const e={...o};e.contractDate=f(e.contractDate),e.expectedDueDate=f(e.expectedDueDate),t.append("contractInfo",JSON.stringify(e)),t.append("itemList",JSON.stringify(l.value));const d=[];_.value.forEach(c=>{c.flag==="N"?t.append("newFiles",c.file):c.flag==="D"&&d.push({attachFileId:c.attachFileId,seq:c.seq})}),t.append("keptFiles",JSON.stringify(_.value.filter(c=>c.flag==="S"))),d.length>0&&t.append("deleteFiles",new Blob([JSON.stringify(d)],{type:"application/json"}));const m=await J.updateContractInfo(t);z(m),S.push({name:"ContractDetail",params:{id:q}})}catch(e){j(e.message)}};M(()=>o.contractDate,async(t,e)=>{xe(f(e))||e!==f(t)&&(o.seq=await k.getNextSeq("tb_contract_mst","contract_Date",f(t)))}),M(()=>o.vatType,async t=>{o.vatType==="VRN"?l.value.map(e=>{e.vatPrice=0}):l.value.map(e=>{e.vatPrice=H(e.supplyPrice)})});const $=t=>{const e=Number(l.value[t].qty),d=Number(l.value[t].unitPrice);!isNaN(e)&&!isNaN(d)?l.value[t].supplyPrice=e*d:l.value[t].supplyPrice=0,isNaN(l.value[t].supplyPrice)?l.value[t].vatPrice=0:l.value[t].vatPrice=H(l.value[t].supplyPrice),isNaN(l.value[t].supplyPrice)?l.value[t].totPrice=0:l.value[t].totPrice=l.value[t].supplyPrice+l.value[t].vatPrice},X=t=>{switch(U.value){case"C":o.clientName=t.clientName,o.clientId=t.clientId;break;case"U":o.managerName=t.memberNm,o.managerId=t.userId;break;case"I":Y(t);break}U.value=""},Y=t=>{if(!Array.isArray(t))return;let e=F.value;const d=t.map((m,c)=>({itemCd:m.itemCd,itemName:m.itemName,unit:m.unit,prodType:m.prodType,qty:m.qty,unitPrice:m.unitPrice,supplyPrice:m.supplyPrice,vatPrice:0,totPrice:0,orderCnt:"",statusType:"",etc:m.etc,orderDist:e+c+1}));l.value.length>0?l.value.push(...d):l.value=[...d]},I=t=>{switch(U.value=t,t){case"C":P.value=Ne,x.value="800px",b.value="800px";break;case"U":P.value=Ce,x.value="800px",b.value="800px";break;case"I":P.value=be,x.value="800px",b.value="850px";break}V.value=!0},ee=t=>{const e=l.value.findIndex(d=>d.itemCd===t);l.value.splice(e,1)};ve(async()=>{L.value=await k.getCodeList("order_type"),B.value=await k.getCodeList("status_Type"),A.value=await k.getCodeList("vat_type");const t=await J.getContractInfo(q);Object.assign(o,t.contractInfo),t.attachFileInfo!==null?_.value=t.attachFileInfo:_.value=[],l.value=t.itemList,F.value=l.value.length});const te=()=>{S.push({name:"ContractList"})};return(t,e)=>{const d=u("v-breadcrumbs"),m=u("v-card-item"),c=u("v-date-input"),N=u("v-text-field"),p=u("v-col"),g=u("v-row"),D=u("v-select"),E=u("v-card-text"),ae=u("v-card-subtitle"),T=u("v-btn"),le=u("v-icon"),ie=u("v-data-table-virtual"),ne=u("v-form"),oe=u("v-card"),se=u("v-dialog");return O(),ye(fe,null,[y("div",{id:t.$attrs.id},null,8,ke),a(d,{items:["MES","영업관리","주문수정"],class:"custom-breadcrumbs"}),a(oe,null,{default:n(()=>[a(m,{title:"주문서입력"}),a(ne,{ref:"vform",onSubmit:ge(Q,["prevent"])},{default:n(()=>[a(E,null,{default:n(()=>[a(g,null,{default:n(()=>[a(p,{class:"d-flex ga-2 pa-1"},{default:n(()=>[a(c,{modelValue:o.contractDate,"onUpdate:modelValue":e[0]||(e[0]=i=>o.contractDate=i),label:"주문일자",density:"compact","display-format":R(f),variant:"underlined",style:{width:"200px"}},null,8,["modelValue","display-format"]),a(N,{modelValue:o.seq,"onUpdate:modelValue":e[1]||(e[1]=i=>o.seq=i),density:"compact",style:{width:"40px"},readonly:""},null,8,["modelValue"])]),_:1}),a(p,null,{default:n(()=>[a(c,{modelValue:o.expectedDueDate,"onUpdate:modelValue":e[2]||(e[2]=i=>o.expectedDueDate=i),label:"납기예정일자",density:"compact","display-format":R(f),variant:"underlined",style:{width:"200px"},"hide-details":""},null,8,["modelValue","display-format"])]),_:1}),a(p,null,{default:n(()=>[a(N,{modelValue:o.paymentCondition,"onUpdate:modelValue":e[3]||(e[3]=i=>o.paymentCondition=i),label:"결제조건",variant:"underlined",density:"compact",style:{width:"200px"},"hide-details":""},null,8,["modelValue"])]),_:1}),a(p,null,{default:n(()=>[a(N,{modelValue:o.managerName,"onUpdate:modelValue":e[4]||(e[4]=i=>o.managerName=i),label:"담당자명",variant:"underlined",density:"compact","append-inner-icon":"mdi-magnify","onClick:appendInner":e[5]||(e[5]=i=>I("U")),style:{width:"200px"}},null,8,["modelValue"])]),_:1})]),_:1}),a(g,null,{default:n(()=>[a(p,{cols:"6"},{default:n(()=>[a(N,{modelValue:o.clientName,"onUpdate:modelValue":e[6]||(e[6]=i=>o.clientName=i),label:"고객사",variant:"underlined",density:"compact","append-inner-icon":"mdi-magnify","onClick:appendInner":e[7]||(e[7]=i=>I("C"))},null,8,["modelValue"])]),_:1}),a(p,null,{default:n(()=>[a(D,{modelValue:o.vatType,"onUpdate:modelValue":e[8]||(e[8]=i=>o.vatType=i),label:"거래유형",items:A.value,"item-title":"codeNm","item-value":"code",variant:"underlined",density:"compact",style:{width:"200px"}},null,8,["modelValue","items"])]),_:1}),a(p,null,{default:n(()=>[a(D,{modelValue:o.orderType,"onUpdate:modelValue":e[9]||(e[9]=i=>o.orderType=i),label:"수주유형",items:L.value,"item-title":"codeNm","item-value":"code",variant:"underlined",density:"compact",style:{width:"200px"}},null,8,["modelValue","items"])]),_:1})]),_:1}),a(g,null,{default:n(()=>[a(p,{cols:"12"},{default:n(()=>[a(Pe,{modelValue:_.value,"onUpdate:modelValue":e[10]||(e[10]=i=>_.value=i)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(E,null,{default:n(()=>[a(g,null,{default:n(()=>[a(p,null,{default:n(()=>[a(ae,null,{default:n(()=>[...e[14]||(e[14]=[we(" - 품목 ",-1)])]),_:1})]),_:1}),a(p,{class:"d-flex ga-4 justify-end"},{default:n(()=>[a(T,{text:"추가 +",density:"compact",onClick:e[11]||(e[11]=i=>I("I"))})]),_:1})]),_:1}),a(g,null,{default:n(()=>[a(p,null,{default:n(()=>[a(ie,{headers:G,items:l.value,density:"compact","item-value":"id",class:"custom-table no-padding-table"},{"item.statusType":n(({item:i})=>[a(D,{modelValue:i.statusType,"onUpdate:modelValue":s=>i.statusType=s,items:B.value,"item-title":"codeNm","item-value":"code",density:"compact",variant:"outlined",style:{width:"120px",height:"40px"}},null,8,["modelValue","onUpdate:modelValue","items"])]),"item.qty":n(({item:i,index:s})=>[w(y("input",{"onUpdate:modelValue":r=>l.value[s].qty=r,style:{"text-align":"right",width:"90%"},class:"custom-line",onBlur:r=>$(s)},null,40,Ue),[[h,l.value[s].qty]])]),"item.unitPrice":n(({item:i,index:s})=>[w(y("input",{"onUpdate:modelValue":r=>l.value[s].unitPrice=r,style:{"text-align":"right",width:"90%","min-width":"90%","max-width":"90%"},class:"custom-line",onBlur:r=>$(s)},null,40,Ie),[[h,l.value[s].unitPrice]])]),"item.supplyPrice":n(({item:i,index:s})=>[w(y("input",{"onUpdate:modelValue":r=>l.value[s].supplyPrice=r,type:"number",style:{"text-align":"right",width:"90%","min-width":"90%","max-width":"90%"},class:"custom-line"},null,8,De),[[h,l.value[s].supplyPrice]])]),"item.vatPrice":n(({item:i,index:s})=>[w(y("input",{"onUpdate:modelValue":r=>l.value[s].vatPrice=r,type:"number",style:{"text-align":"right",width:"90%","min-width":"90%","max-width":"90%"},class:"custom-line"},null,8,Te),[[h,l.value[s].vatPrice,void 0,{number:!0}]])]),"item.totPrice":n(({item:i,index:s})=>[w(y("input",{"onUpdate:modelValue":r=>l.value[s].totPrice=r,type:"number",style:{"text-align":"right",width:"90%","min-width":"90%","max-width":"90%"},class:"custom-line"},null,8,qe),[[h,l.value[s].totPrice,void 0,{number:!0}]])]),"item.etc":n(({item:i,index:s})=>[w(y("input",{"onUpdate:modelValue":r=>l.value[s].etc=r,type:"text",style:{"text-align":"left",width:"90%","min-width":"90%","max-width":"90%"},class:"custom-line"},null,8,Se),[[h,l.value[s].etc]])]),"item.actions":n(({item:i})=>[a(le,{color:"medium-emphasis",icon:"mdi-delete",size:"small",onClick:s=>ee(i.itemCd)},null,8,["onClick"])]),_:1},8,["items"])]),_:1})]),_:1}),a(g,{class:"mt-2 mb-2"},{default:n(()=>[a(p,{class:"d-flex ga-4 justify-end"},{default:n(()=>[a(T,{text:"저장",class:"gt-2",color:"brown-lighten-4",type:"submit"}),a(T,{text:"목록",class:"mr-3",onClick:te})]),_:1})]),_:1})]),_:1})]),_:1},512)]),_:1}),a(se,{modelValue:V.value,"onUpdate:modelValue":e[13]||(e[13]=i=>V.value=i),width:x.value,height:b.value,persistent:""},{default:n(()=>[(O(),he(Ve(P.value),{id:t.id,onSelected:X,onCloseDialog:e[12]||(e[12]=i=>V.value=!1)},null,40,["id"]))]),_:1},8,["modelValue","width","height"])],64)}}},tt=ue(Fe,[["__scopeId","data-v-580465ad"]]);export{tt as default};

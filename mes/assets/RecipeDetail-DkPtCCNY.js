import{r as h,u as ne,a as oe,y as le,p as re,k as se,B as T,m as ie,c as ce,f as R,g as a,d as p,w as l,F as de,e as ue,o as O,j as me,i as pe,t as S,b as fe,z as ve}from"./index-DjI8e8VZ.js";import{i as f,d as we,e as j}from"./common-DeQ1G7iv.js";import{A as N}from"./apiLab-C2sC-jhp.js";import{A as _e}from"./apiItem-slwuKuQH.js";import{H as b,_ as ge}from"./index-CbWiV_Pe.js";import{_ as ye}from"./UserListPop-BghcWnxN.js";import{_ as Ne}from"./ClientListPop-Dt4lFxyy.js";import"./format-DWu4U6B8.js";import"./_commonjsHelpers-CZnAS8i4.js";import"./apiBase-CRBLZO_5.js";const he=["id"],Le={__name:"RecipeDetail",setup(be){const P=h(!1),I=h(null),{vError:x,vSuccess:B,vInfo:D,vWarning:_}=ne(),E=ue(),M=re(),{userId:H}=oe(),V=h(null),U=le(null),F=M.params.id,A=h(""),v=h([{phase:"",itemCd:"",itemName:"",content:0,inPrice:0,unitPrice:0}]),k=h([]),n=se({clientName:"",clientId:"",prodName:"",managerName:"",managerId:"",regDate:"",labNo:"",prodType:"",recipeId:F,userId:H}),z=[{data:"sortDist",readOnly:!0,className:"htCenter",width:60},{data:"phase",type:b.cellTypes.text,width:60,className:"htCenter"},{data:"itemCd",type:b.cellTypes.text,width:180,className:"htCenter"},{data:"itemName",type:b.cellTypes.text,width:720},{data:"content",type:b.cellTypes.numeric,width:200,className:"htRight"},{data:"inPrice",type:b.cellTypes.numeric,width:200,className:"htRight"},{data:"unitPrice",type:b.cellTypes.numeric,width:200,className:"htRight"}],J=async()=>{if(f(n.clientName)){_("고객사 정보를 입력해주세요.");return}if(f(n.prodName)){_("제품명을 입력해주세요.");return}if(f(n.prodType)){_("제형코드를 입력해주세요.");return}if($.value!==100){_("함량의 합이 100이 아닙니다. 확인해주세요.");return}try{const t={recipeInfo:{...n},recipeList:v.value};t.recipeInfo.regDate=j(t.recipeInfo.regDate);const e=await N.saveRecipeInfo(t);n.recipeId=e.data.recipeId,B("저장되었습니다.")}catch(t){x(t.message||"저장 중 오류가 발생했습니다.")}},L=t=>{A.value=t,t==="C"?U.value=Ne:t==="U"&&(U.value=ye),P.value=!0},K=t=>{A.value==="C"?(n.clientName=t.clientName,n.clientId=t.clientId):A.value==="U"&&(n.managerId=t.userId,n.managerName=t.memberNm)},W=async(t,e)=>{var r,d;if(!t)return;const o=(d=(r=I.value)==null?void 0:r.hotInstance)==null?void 0:d.hotInstance;if(!o)return;let s=0;for(const[u,C,m,w]of t){if(C==="itemCd"&&w&&w!==m)try{s=s+1,o.setDataAtRowProp(u,"sortDist",s);let c=null;if(w.charAt(0).toUpperCase()==="J"?c=await _e.getItemInfo(w):(c=await N.getNewMaterialInfo(w),c=c.getNewMaterialInfo),c){o.setDataAtRowProp(u,"inPrice",c.inPrice||0);const g=Number(o.getDataAtRowProp(u,"content"));if(!isNaN(g)&&c.inPrice!=null){let y=g*c.inPrice*.001*.01;y=parseFloat(y.toFixed(7)),o.setDataAtRowProp(u,"unitPrice",y)}}else o.setDataAtRowProp(u,"inPrice",0)}catch(c){console.error("품목 조회 오류:",c)}if(C==="content"&&w!==m){const c=Number(w),g=Number(o.getDataAtRowProp(u,"inPrice"));if(!isNaN(c)&&!isNaN(g)&&g>0){const y=parseFloat((c*g*.001*.01).toFixed(7));o.setDataAtRowProp(u,"unitPrice",y)}}}},$=T(()=>{const t=v.value.reduce((e,o)=>e+(Number(o.content)||0),0);return parseFloat(t.toFixed(7))}),q=T(()=>v.value.reduce((t,e)=>t+(Number(e.inPrice)||0),0)),G=T(()=>v.value.reduce((t,e)=>t+(Number(e.unitPrice)||0),0).toFixed(7)),Q=()=>{var r,d;const t=(d=(r=I.value)==null?void 0:r.hotInstance)==null?void 0:d.hotInstance,e=(t==null?void 0:t.getSourceData())||[],o=e.length>0?Math.max(...e.map(u=>u.sortDist||0))+1:1,s={sort_dist:o,phase:"",itemCd:"",itemName:"",content:0,inPrice:0,unitPrice:0};t?(t.alter("insert_row_above",e.length),t.setDataAtRowProp(e.length,"sortDist",o),t.setDataAtRowProp(e.length,"phase",""),t.setDataAtRowProp(e.length,"itemCd",""),t.setDataAtRowProp(e.length,"itemName",""),t.setDataAtRowProp(e.length,"content",0),t.setDataAtRowProp(e.length,"inPrice",0),t.setDataAtRowProp(e.length,"unitPrice",0)):v.value.push(s)},X=(t,e,o,s)=>{V.value=[t,e,o,s]},Y=()=>{var s,r;if(!V.value){_("삭제할 행을 선택하세요.");return}const[t,,e]=V.value,o=(r=(s=I.value)==null?void 0:s.hotInstance)==null?void 0:r.hotInstance;o&&o.alter("remove_row",t,e-t+1)};ie(async()=>{var e,o;if(k.value=await N.getProdTypeList(),n.prodType=((e=k.value[0])==null?void 0:e.code)??null,!!((o=I.value)==null?void 0:o.hotInstance))if(f(n.recipeId))n.regDate=we();else{const s=await N.getRecipeInfo(n.recipeId);Object.assign(n,s.recipeInfo),v.value.splice(0,v.value.length,...s.recipeList)}});const Z=async()=>{if(f(n.recipeId)){D("처방정보가 없습니다. 저장 후 시도해주세요.");return}if(f(n.prodType)){_("제형코드를 입력해주세요.");return}try{const t={recipeInfo:{...n},recipeList:v.value},e=await N.downloadRecipe(t),o=window.URL.createObjectURL(e),s=document.createElement("a");s.href=o,s.download=`recipe_${n.prodName}.xlsx`,s.click(),window.URL.revokeObjectURL(o)}catch(t){x("엑셀 다운로드 실패",t)}},ee=async()=>{if(f(n.recipeId)){D("처방정보가 없습니다. 저장 후 시도해주세요.");return}if(f(n.prodType)){_("제형코드를 입력해주세요.");return}try{const t=await N.downloadIngredient(n.recipeId),e=window.URL.createObjectURL(t),o=document.createElement("a");o.href=e,o.download=`전성분_${n.prodName}.xlsx`,o.click(),window.URL.revokeObjectURL(e)}catch(t){x("엑셀 다운로드 실패",t)}},te=async()=>{if(f(n.recipeId)){D("처방정보가 없습니다. 저장 후 시도해주세요.");return}if(f(n.prodType)){_("제형코드를 입력해주세요.");return}try{const t=await N.downloadIngredientCn(F),e=window.URL.createObjectURL(t),o=document.createElement("a");o.href=e,o.download=`중국위생허가_${n.prodName}.xlsx`,o.click(),window.URL.revokeObjectURL(e)}catch(t){x("엑셀 다운로드 실패",t)}},ae=()=>{E.push({name:"RecipeList"})};return(t,e)=>{const o=p("v-breadcrumbs"),s=p("v-text-field"),r=p("v-col"),d=p("v-row"),u=p("v-date-input"),C=p("v-select"),m=p("v-btn"),w=p("v-form"),c=p("v-card-text"),g=p("v-card"),y=p("v-dialog");return O(),ce(de,null,[R("div",{id:t.$attrs.id},null,8,he),a(o,{items:["MES","연구관리","처방상세"]}),a(g,null,{default:l(()=>[a(c,null,{default:l(()=>[a(w,{onSubmit:me(J,["prevent"])},{default:l(()=>[a(d,null,{default:l(()=>[a(r,null,{default:l(()=>[a(s,{modelValue:n.clientName,"onUpdate:modelValue":e[0]||(e[0]=i=>n.clientName=i),label:"고객사",variant:"underlined",density:"compact","append-inner-icon":"mdi-magnify","onClick:appendInner":e[1]||(e[1]=i=>L("C"))},null,8,["modelValue"])]),_:1}),a(r,null,{default:l(()=>[a(s,{modelValue:n.prodName,"onUpdate:modelValue":e[2]||(e[2]=i=>n.prodName=i),label:"제품명",variant:"underlined",density:"compact"},null,8,["modelValue"])]),_:1})]),_:1}),a(d,null,{default:l(()=>[a(r,null,{default:l(()=>[a(s,{modelValue:n.managerName,"onUpdate:modelValue":e[3]||(e[3]=i=>n.managerName=i),label:"담당자명",variant:"underlined",density:"compact","append-inner-icon":"mdi-magnify","onClick:appendInner":e[4]||(e[4]=i=>L("U"))},null,8,["modelValue"])]),_:1}),a(r,null,{default:l(()=>[a(u,{modelValue:n.regDate,"onUpdate:modelValue":e[5]||(e[5]=i=>n.regDate=i),label:"등록일","display-format":pe(j),variant:"underlined",density:"compact"},null,8,["modelValue","display-format"])]),_:1}),a(r,null,{default:l(()=>[a(s,{modelValue:n.labNo,"onUpdate:modelValue":e[6]||(e[6]=i=>n.labNo=i),label:"Lab No",variant:"underlined",density:"compact"},null,8,["modelValue"])]),_:1}),a(r,null,{default:l(()=>[a(C,{modelValue:n.prodType,"onUpdate:modelValue":e[7]||(e[7]=i=>n.prodType=i),label:"제형코드",items:k.value,"item-title":"codeNm","item-value":"code",variant:"underlined",density:"compact"},null,8,["modelValue","items"])]),_:1})]),_:1}),a(d,{class:"justify-end mb-3 mr-2",dense:""},{default:l(()=>[a(r,{cols:"auto"},{default:l(()=>[a(m,{color:"brown-lighten-4",class:"mt-3 mr-3",text:"추가+",density:"compact",onClick:Q})]),_:1}),a(r,{cols:"auto"},{default:l(()=>[a(m,{color:"brown-lighten-4",class:"mt-3",text:"삭제-",density:"compact",onClick:Y})]),_:1})]),_:1}),a(d,null,{default:l(()=>[a(r,null,{default:l(()=>[a(ge,{ref_key:"hotTable",ref:I,data:v.value,colHeaders:["No.","Phase","품목코드","품목명","함량","원가(원)","단가(원/g)"],columns:z,stretchH:"none",height:430,afterChange:W,afterSelection:X},null,8,["data"])]),_:1})]),_:1}),a(d,{class:"d-flex justify-end mb-2 mr-3 dense"},{default:l(()=>[a(r,{cols:"auto"},{default:l(()=>e[11]||(e[11]=[R("strong",null,"합계",-1)])),_:1}),a(r,{cols:"auto"},{default:l(()=>[R("span",null,"함량 : "+S($.value)+"%",1)]),_:1}),a(r,{cols:"auto"},{default:l(()=>[R("span",null,"원가(원) : "+S(q.value.toLocaleString("ko-kr"))+"원",1)]),_:1}),a(r,{cols:"auto"},{default:l(()=>[R("span",null,"단가(원/g) : "+S(G.value)+"원",1)]),_:1})]),_:1}),a(d,{class:"justify-end mb-3 mr-2",dense:""},{default:l(()=>[a(r,{cols:"auto"},{default:l(()=>[a(m,{text:"BOM연결",onClick:e[8]||(e[8]=i=>L("B"))})]),_:1}),a(r,{cols:"auto"},{default:l(()=>[a(m,{text:"저장",color:"brown-lighten-4",type:"submit"})]),_:1}),a(r,{cols:"auto"},{default:l(()=>[a(m,{text:"전성분(수출)",color:"#FFE0B2",onClick:ee})]),_:1}),a(r,{cols:"auto"},{default:l(()=>[a(m,{text:"단가",onClick:Z})]),_:1}),a(r,{cols:"auto"},{default:l(()=>[a(m,{text:"중국위생허가",onClick:te})]),_:1}),a(r,{cols:"auto"},{default:l(()=>[a(m,{text:"목록",onClick:ae})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),a(y,{modelValue:P.value,"onUpdate:modelValue":e[10]||(e[10]=i=>P.value=i),width:"800px",height:"800px",persistent:"",scrim:!1},{default:l(()=>[(O(),fe(ve(U.value),{id:t.id,onSelected:K,onCloseDialog:e[9]||(e[9]=i=>P.value=!1)},null,40,["id"]))]),_:1},8,["modelValue"])],64)}}};export{Le as default};
